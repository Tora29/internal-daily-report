version: '3.8'

services:
  # LocalStack - AWS サービスのローカルエミュレーション
  localstack:
    container_name: internal-daily-report-localstack
    image: localstack/localstack:latest
    ports:
      - '4566:4566' # LocalStack Gateway (AWS互換エンドポイント)
      - '4510-4559:4510-4559' # 外部サービス用ポート範囲
    environment:
      # LocalStack設定
      - SERVICES=s3,lambda,apigateway,cognito-idp,iam,cloudwatch,logs
      - DEBUG=1
      - PERSISTENCE=1 # データ永続化
      - DOCKER_HOST=unix:///var/run/docker.sock
      # AWS認証情報（ダミー、LocalStackでは無視される）
      - AWS_DEFAULT_REGION=ap-northeast-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - './localstack-data:/var/lib/localstack' # データ永続化
      - '/var/run/docker.sock:/var/run/docker.sock' # Docker-in-Docker用
    networks:
      - internal-daily-report-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4566/_localstack/health']
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL - データベース
  postgres:
    container_name: internal-daily-report-postgres
    image: postgres:16-alpine
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=daily_report_dev
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - internal-daily-report-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  postgres-data:
    driver: local

networks:
  internal-daily-report-network:
    driver: bridge
